{{- $isOpenshiftCluster := .Capabilities.APIVersions.Has "apps.openshift.io/v1" -}}
{{- $deployDedicatedMonitoringSystem := .Values.pxbackup.deployDedicatedMonitoringSystem | default true }}
{{- if eq $deployDedicatedMonitoringSystem true }}
apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  name: px-backup-alertmanager
  namespace: {{ .Release.Namespace }}
spec:
  configSecret: px-backup-alertmanager-custom-config
  alertmanagerConfigSelector:
    matchLabels:
      app: px-backup-alert-configs
  replicas: {{ .Values.pxbackup.alertmanager.replicas }}
  retention: {{ .Values.pxbackup.alertmanager.retention}}
  containers:
    - args:
        - '--config.file=/etc/alertmanager/config_out/alertmanager.env.yaml'
        - '--storage.path=/alertmanager'
        - '--data.retention={{ .Values.pxbackup.alertmanager.retention }}'
        - '--cluster.listen-address=[$(POD_IP)]:9094'
        - '--web.listen-address=:9093'
        - '--web.route-prefix=/'
        - '--cluster.label={{ .Release.Namespace }}/px-backup-alertmanager'
        - '--cluster.peer=alertmanager-px-backup-alertmanager-0.alertmanager-operated:9094'
        - '--cluster.peer=alertmanager-px-backup-alertmanager-1.alertmanager-operated:9094'
        - '--cluster.reconnect-timeout=5m'
        - '--web.config.file=/etc/alertmanager/web_config/web-config-custom.yaml'
      env:
        - name: AUTH_SECRET
          valueFrom:
            secretKeyRef:
              name: pxc-backup-metrics
              key: metrics-token
        - name: POD_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.podIP
      image: {{ printf "%s/%s/%s:%s" .Values.images.pxBackupAlertmanagerImage.registry .Values.images.pxBackupAlertmanagerImage.repo .Values.images.pxBackupAlertmanagerImage.imageName .Values.images.pxBackupAlertmanagerImage.tag }}
      name: alertmanager
      ports:
        - containerPort: 9093
          name: web
          protocol: TCP
    - args:
      - --listen-address=:8080
      - --reload-url=http://$(USERNAME):$(PASSWORD)@localhost:9093/-/reload
      - --config-file=/etc/alertmanager/config/alertmanager.yaml.gz
      - --config-envsubst-file=/etc/alertmanager/config_out/alertmanager.env.yaml
      - --watched-dir=/etc/alertmanager/config
      env:
      - name: USERNAME
        valueFrom:
          secretKeyRef:
            key: metrics-username
            name: pxc-backup-metrics
      - name: PASSWORD
        valueFrom:
          secretKeyRef:
            key: metrics-password
            name: pxc-backup-metrics
      name: config-reloader
      ports:
      - containerPort: 8080
        name: reloader-web
        protocol: TCP
  {{- if $isOpenshiftCluster }}
  {{- else }}
  securityContext:
    fsGroup: 2000
    runAsNonRoot: true
    runAsUser: 1000
  {{- end }}
  listenLocal: true
  volumeMounts:
    - mountPath: /etc/alertmanager/web_config/web-config-custom.yaml
      name: web-config-custom
      readOnly: true
      subPath: web-config-custom.yaml
  volumes:
    - name: web-config-custom
      secret:
        defaultMode: 420
        secretName: pxc-backup-metrics
  {{- if .Values.persistentStorage.storageClassName }}
  storage:
    volumeClaimTemplate:
      spec:
        storageClassName: {{ .Values.persistentStorage.storageClassName }}
        resources:
          requests:
            storage: {{ .Values.persistentStorage.prometheus.storage }}
  {{- end }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: px-backup-alertmanager-custom-config
type: Opaque
stringData:
  alertmanager.yaml: |
    route:
      receiver: "null"
    receivers:
    - name: "null"
    templates: [ "/etc/alertmanager/config/*.tmpl" ]
  pxc_template.tmpl: |
    <!DOCTYPE html>
    <html>
      <head>
          <title>Px-Backup Email</title>
          <style>
            body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            background-color: #f4f4f4;
            }
            .container {
            margin: 20px;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            h1 {
            color: #333;
            }
            p {
            color: #666;
            }
            td {
            color: #292929;
            font-size: 14px;
            font-style: normal;
            font-weight: 400;
            }
            .bold-text {
            padding-left: 20px;
            font-weight: bold;
            }
            .pb-16,
            td {
            padding-bottom: 16px;
            }
          </style>
      </head>
      <body>
          <div class="container">
            <img height="50px" src="https://portworx.com/wp-content/themes/portworx/assets/images/header/portworx-logo.png" alt="" srcset="">
            {{ range .Alerts }}
            {{- if eq .Labels.alertname "ClusterAlert"}}
            <div
                class="pb-16"
                style="width: 400px; color: #bc1b06; font-size: 18px; font-weight: 500">
                Critical Alert: Cluster Disconnected
            </div>
            <div
                class="pb-16"
                style="
                color: var(--content-onBase-strong, #292929);
                font-size: 16px;
                font-weight: 700;
                "
                >
                Alert details
            </div>
            <table>
                <tr>
                  <td>Cluster name</td>
                  <td class="bold-text">{{ .Labels.name }}</td>
                </tr>
                <tr>
                  <td>Error</td>
                  <td class="bold-text">Reason to be added here...</td>
                </tr>
                <tr>
                  <td>Creation time</td>
                  <td class="bold-text">{{ .StartsAt.Format "2006-01-02 15:04:05" }}</td>
                </tr>
            </table>
            {{- else if eq .Labels.alertname "BackupAlert" }}
            <div
                class="pb-16"
                style="width: 400px; color: #bc1b06; font-size: 18px; font-weight: 500">
                Critical Alert: Backup Failed
            </div>
            <div
                class="pb-16"
                style="
                color: var(--content-onBase-strong, #292929);
                font-size: 16px;
                font-weight: 700;
                "
                >
                Alert details
            </div>
            <table>
                <tr>
                  <td>Backup name</td>
                  <td class="bold-text">{{ .Labels.name }}</td>
                </tr>
                <tr>
                  <td>Cluster name</td>
                  <td class="bold-text">{{ .Labels.cluster }}</td>
                </tr>
                <tr>
                  <td>Error</td>
                  <td class="bold-text">Reason to be added here...</td>
                <tr>
                  <td>Creation time</td>
                  <td class="bold-text">{{ .StartsAt.Format "2006-01-02 15:04:05" }}</td>
                </tr>
            </table>
            {{- else if eq .Labels.alertname "RestoreAlert" }}
            <div
                class="pb-16"
                style="width: 400px; color: #bc1b06; font-size: 18px; font-weight: 500">
                Critical Alert: Restore Failed
            </div>
            <div
                class="pb-16"
                style="
                color: var(--content-onBase-strong, #292929);
                font-size: 16px;
                font-weight: 700;
                "
                >
                Alert details
            </div>
            <table>
                <tr>
                  <td>Restore name</td>
                  <td class="bold-text">{{ .Labels.name }}</td>
                </tr>
                <tr>
                  <td>Cluster name</td>
                  <td class="bold-text">{{ .Labels.cluster }}</td>
                </tr>
                <tr>
                  <td>Error</td>
                  <td class="bold-text">Reason to be added here...</td>
                <tr>
                  <td>Creation time</td>
                  <td class="bold-text">{{ .StartsAt.Format "2006-01-02 15:04:05" }}</td>
                </tr>
            </table>
            {{- else if eq .Labels.alertname "BackupLocationAlert" }}
            <div
                class="pb-16"
                style="width: 400px; color: #bc1b06; font-size: 18px; font-weight: 500">
                Critical Alert: Backup Location Disconnected
            </div>
            <div
                class="pb-16"
                style="
                color: var(--content-onBase-strong, #292929);
                font-size: 16px;
                font-weight: 700;
                "
                >
                Alert details
            </div>
            <table>
                <tr>
                  <td>Backup Location</td>
                  <td class="bold-text">{{ .Labels.name }}</td>
                </tr>
                <tr>
                  <td>Error</td>
                  <td class="bold-text">Reason to be added here...</td>
                <tr>
                  <td>Creation time</td>
                  <td class="bold-text">{{ .StartsAt.Format "2006-01-02 15:04:05" }}</td>
                </tr>
            </table>
            {{- end }}
            {{ end }}
            <div style="font-size: 14px" class="pb-16">
                Please login to your Portworx Backup deployment to see more details and
                take corrective actions.
            </div>
            <div style="font-size: 14px" class="pb-16">
                Best Regards,<br />Portworx Team
            </div>
          </div>
      </body>
    </html>
