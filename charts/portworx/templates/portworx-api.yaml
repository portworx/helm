{{- if (.Values.api.enabled ) }}
  {{- $customRegistryURL := .Values.customRegistryURL | default "none" }}
kind: Service
apiVersion: v1
metadata:
  name: portworx-api
  namespace: kube-system
  labels:
    name: portworx-api
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{.Release.Service | quote }}
    app.kubernetes.io/instance: {{.Release.Name | quote }}
    chart: "{{.Chart.Name}}-{{.Chart.Version}}"
spec:
  selector:
    name: portworx-api
  type: ClusterIP
  ports:
    - name: px-api
      protocol: TCP
      port: 9001
      targetPort: 9001
    - name: px-sdk
      protocol: TCP
      port: 9020
      targetPort: 9020
    - name: px-rest-gateway
      protocol: TCP
      port: 9021
      targetPort: 9021
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: portworx-api
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: portworx-api
  minReadySeconds: 0
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 100%
  template:
    metadata:
      labels:
        name: portworx-api
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: px/enabled
                    operator: NotIn
                    values:
                      - "false"
                  {{- if (.Values.openshiftInstall) and (eq .Values.openshiftInstall true)}}
                  - key: openshift-infra
                    operator: DoesNotExist
                  {{- else if (not .Values.deployOnMaster) or (eq .Values.deployOnMaster false)}}
                  - key: node-role.kubernetes.io/master
                    operator: DoesNotExist
      {{- end }}
      hostNetwork: true
      hostPID: false
      containers:
        - name: portworx-api
          {{- if eq $customRegistryURL "none" }}
          image: "k8s.gcr.io/pause:3.1"
          {{- else }}
          image: "{{ $customRegistryURL }}/pause:3.1"
          {{- end}}
          imagePullPolicy: Always
          readinessProbe:
            periodSeconds: 10
            httpGet:
              host: 127.0.0.1
              path: /status
              port: 9001
      restartPolicy: Always
      serviceAccountName: px-account
  {{- end }}
